name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'site/**'
      - 'docs/**'
      - 'pkg/**/*.md'
      - 'examples/**/*.md'
      - 'README.md'
      - 'CHANGELOG.md'
      - 'DEVELOPMENT.md'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-docs
  cancel-in-progress: false

env:
  HUGO_VERSION: '0.155.3'

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout kure repo
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install Hugo CLI
      run: |
        wget -q -O ${{ runner.temp }}/hugo.deb \
          https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

    - name: Check mounted files exist
      run: bash site/scripts/check-mounts.sh

    - name: Inject front matter
      run: bash site/scripts/inject-frontmatter.sh

    - name: Build Hugo site
      working-directory: site
      env:
        HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
        HUGO_ENVIRONMENT: production
      run: hugo --minify --baseURL "https://www.gokure.dev/"

    - name: Checkout go-kure.github.io
      uses: actions/checkout@v6
      with:
        repository: go-kure/go-kure.github.io
        token: ${{ secrets.DEPLOY_TOKEN }}
        path: deploy-target

    - name: Deploy to go-kure.github.io
      run: |
        cd deploy-target

        # Preserve CNAME and .nojekyll
        cp CNAME /tmp/CNAME 2>/dev/null || echo "www.gokure.dev" > /tmp/CNAME

        # Clear existing content (except .git)
        find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

        # Copy built site
        cp -r ../site/public/* .

        # Restore deployment files
        cp /tmp/CNAME CNAME
        touch .nojekyll

        # Get kure commit info for the commit message
        KURE_SHA=$(cd .. && git rev-parse --short HEAD)
        KURE_DATE=$(cd .. && git log -1 --format=%ci)

        # Commit and push
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to deploy"
        else
          git commit -m "deploy: update docs from kure@${KURE_SHA}" \
            -m "Source commit: ${KURE_SHA} (${KURE_DATE})"
          git push
        fi
